export const state = () => ({
  init: false,
  slots: false,
  prefix: '/1092744/telegram/',
  units: {
    telegram_desktop_billboard_v1: {
      upc: false,
      mobile: [
        [1, 1],
        [300, 50],
        [300, 100],
        [300, 250],
        [320, 50],
        [320, 250],
      ],
      desktop: [
        [1, 1],
        [970, 250],
        [970, 500],
        [1000, 250],
        [1000, 500],
        [1200, 250],
        [1200, 500],
      ],
      routes: [
        'index',
        'category',
        'category-slug',
        'super1',
        'telesport',
        'super1-category',
        'telesport-category',
        'nesto-slug',
        'fotogalerije-category',
        'fotogalerije-category-slug',
        'category',
        'search',
        'autor-autor',
        'tema-tema',
        'super1-category-slug',
        'telesport-category-slug',
        'pitanje-zdravlja-category-slug',
        'openspace-category-slug',
        'pitanje-zdravlja-category',
        'openspace-category',
      ],
    },
    telegram_desktop_billboard_v2: {
      upc: false,
      routes: [
        'index',
        'category',
        'super1',
        'super1-category',
        'telesport',
        'telesport-category',
        'pitanje-zdravlja-category',
        'openspace-category',
      ],
      mobile: [
        [1, 1],
        [300, 50],
        [300, 100],
        [300, 250],
        [320, 50],
        [320, 480],
        [300, 600],
        [320, 250],
      ],
      desktop: [
        [1, 1],
        [660, 350],
        [660, 500],
        [970, 250],
        [970, 500],
        [1000, 250],
        [1000, 500],
        [1200, 250],
        [1200, 500],
      ],
    },
    telegram_desktop_billboard_v3: {
      upc: false,
      routes: [
        'index',
        'category',
        'super1',
        'super1-category',
        'telesport',
        'telesport-category',
        'pitanje-zdravlja-category',
        'openspace-category',
      ],
      mobile: [
        [1, 1],
        [300, 50],
        [300, 100],
        [300, 250],
        [320, 50],
        [320, 480],
        [300, 600],
        [320, 250],
      ],
      desktop: [
        [1, 1],
        [660, 350],
        [660, 500],
        [970, 250],
        [970, 500],
        [1000, 250],
        [1000, 500],
        [1200, 250],
        [1200, 500],
      ],
    },
    telegram_desktop_billboard_v4: {
      upc: false,
      routes: ['index', 'super1', 'telesport'],
      mobile: [
        [1, 1],
        [300, 50],
        [300, 100],
        [300, 250],
        [320, 50],
        [320, 480],
        [300, 600],
        [320, 250],
      ],
      desktop: [
        [1, 1],
        [660, 350],
        [660, 500],
        [970, 250],
        [970, 500],
        [1000, 250],
        [1000, 500],
        [1200, 250],
        [1200, 500],
      ],
    },
    telegram_desktop_wallpaper_left: {
      upc: false,
      desktop: [
        [1, 1],
        [300, 600],
        [300, 900],
        [200, 900],
        [340, 1050],
        [350, 1080],
      ],
      mobile: false,
      routes: [
        'index',
        'category',
        'category-slug',
        'super1',
        'super1-category',
        'super1-category-slug',
        'telesport',
        'telesport-category',
        'telesport-category-slug',
        'nesto-slug',
        'fotogalerije-category',
        'fotogalerije-category-slug',
        'category',
        'search',
        'autor-autor',
        'tema-tema',
        'pitanje-zdravlja-category-slug',
        'openspace-category-slug',
        'pitanje-zdravlja-category',
        'openspace-category',
      ],
    },
    telegram_dekstop_wallpaper_right: {
      upc: false,
      desktop: [
        [1, 1],
        [301, 601],
        [301, 901],
        [201, 901],
        [341, 1051],
        [351, 1081],
      ],
      mobile: false,
      routes: [
        'index',
        'category',
        'category-slug',
        'super1',
        'super1-category',
        'super1-category-slug',
        'telesport',
        'telesport-category',
        'telesport-category-slug',
        'nesto-slug',
        'nesto-slug',
        'fotogalerije-category',
        'fotogalerije-category-slug',
        'category',
        'search',
        'autor-autor',
        'tema-tema',
        'pitanje-zdravlja-category-slug',
        'openspace-category-slug',
        'pitanje-zdravlja-category',
        'openspace-category',
      ],
    },
    telegram_desktop_intext_v1: {
      upc: false,
      routes: [
        'category-slug',
        'nesto-slug',
        'super1-category-slug',
        'pitanje-zdravlja-category-slug',
        'openspace-category-slug',
        'pitanje-zdravlja-category',
        'openspace-category',
        'super1-category',
        'telesport-category',
        'telesport-category-slug',
      ],
      desktop: [
        [1, 1],
        [660, 350],
        [660, 500],
        [300, 250],
        [300, 600],
        [710, 350],
        [970, 250],
        [970, 500],
        [1200, 250],
        [660, 600],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
        [320, 250],
      ],
    },
    telegram_desktop_intext_v2: {
      upc: false,
      routes: [
        'category-slug',
        'nesto-slug',
        'super1-category-slug',
        'pitanje-zdravlja-category-slug',
        'openspace-category-slug',
        'pitanje-zdravlja-category',
        'openspace-category',
        'super1-category',
        'telesport-category',
        'telesport-category-slug',
      ],
      desktop: [
        [1, 1],
        [660, 350],
        [660, 500],
        [300, 250],
        [300, 600],
        [320, 480],
        [710, 350],
        [970, 500],
        [660, 600],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
        [320, 250],
      ],
    },
    telegram_desktop_intext_v3: {
      upc: false,
      routes: [
        'category-slug',
        'nesto-slug',
        'super1-category-slug',
        'pitanje-zdravlja-category-slug',
        'openspace-category-slug',
        'pitanje-zdravlja-category',
        'openspace-category',
        'super1-category',
        'telesport-category',
        'telesport-category-slug',
      ],
      desktop: [
        [1, 1],
        [660, 350],
        [660, 500],
        [300, 250],
        [300, 600],
        [320, 480],
        [710, 350],
        [970, 500],
        [660, 600],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
        [320, 250],
      ],
    },
    telegram_desktop_intext_v4: {
      upc: false,
      routes: [
        'category-slug',
        'nesto-slug',
        'super1-category-slug',
        'pitanje-zdravlja-category-slug',
        'openspace-category-slug',
        'pitanje-zdravlja-category',
        'openspace-category',
        'super1-category',
        'telesport-category',
        'telesport-category-slug',
      ],
      desktop: [
        [1, 1],
        [660, 350],
        [660, 500],
        [300, 250],
        [300, 600],
        [320, 480],
        [710, 350],
        [970, 500],
        [660, 600],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
        [320, 250],
      ],
    },
    telegram_desktop_intext_v5: {
      upc: false,
      routes: [
        'category-slug',
        'nesto-slug',
        'super1-category-slug',
        'pitanje-zdravlja-category-slug',
        'openspace-category-slug',
        'pitanje-zdravlja-category',
        'openspace-category',
        'super1-category',
        'telesport-category',
        'telesport-category-slug',
      ],
      desktop: [
        [1, 1],
        [660, 350],
        [660, 500],
        [300, 250],
        [300, 600],
        [320, 480],
        [710, 350],
        [970, 500],
        [660, 600],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
        [320, 250],
      ],
    },
    telegram_desktop_intext_v6: {
      upc: false,
      routes: [
        'category-slug',
        'nesto-slug',
        'super1-category-slug',
        'pitanje-zdravlja-category-slug',
        'openspace-category-slug',
        'pitanje-zdravlja-category',
        'openspace-category',
        'super1-category',
        'telesport-category',
        'telesport-category-slug',
      ],
      desktop: [
        [1, 1],
        [660, 350],
        [660, 500],
        [300, 250],
        [300, 600],
        [320, 480],
        [710, 350],
        [970, 500],
        [660, 600],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
        [320, 250],
      ],
    },
    telegram_sticky: {
      upc: 4,
      routes: [
        'index',
        'category',
        'super1',
        'super1-category',
        'category-slug',
        'super1-category-slug',
        'nesto-slug',
        'fotogalerije-category',
        'fotogalerije-category-slug',
        'category',
        'search',
        'autor-autor',
        'tema-tema',
        'pitanje-zdravlja-category-slug',
        'openspace-category-slug',
        'pitanje-zdravlja-category',
        'openspace-category',
        'telesport-category',
        'telesport-category-slug',
        'telesport',
      ],
      mobile: [
        [1, 1],
        [300, 50],
        [300, 100],
        [320, 50],
        [320, 150],
        [320, 200],
        [200, 250],
        [320, 480],
        [250, 280],
      ],
      desktop: [
        [900, 600],
        [728, 90],
        [970, 90],
        [970, 150],
        [984, 150],
        [1200, 150],
        [1200, 200],
        [2000, 300],
      ],
    },
    telegram_back_widget: {
      upc: 4,
      routes: [
        'index',
        'category',
        'super1',
        'super1-category',
        'category-slug',
        'super1-category-slug',
        'nesto-slug',
        'fotogalerije-category',
        'fotogalerije-category-slug',
        'category',
        'search',
        'autor-autor',
        'tema-tema',
        'pitanje-zdravlja-category-slug',
        'openspace-category-slug',
        'pitanje-zdravlja-category',
        'openspace-category',
        'telesport-category',
        'telesport-category-slug',
        'telesport',
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
        [320, 250],
      ],
      desktop: false,
    },
  },
  route: '',
  interstitialSlot: false,
})

export const mutations = {
  setInit(state) {
    state.init = true
  },
  setSlots(state) {
    state.slots = true
  },
  setRoute(state, route) {
    state.route = route.name
  },
  setInterstitialSlot(state, payload) {
    state.interstitialSlot = payload
  },
}

export const actions = {
  initAds({ state, commit, dispatch, rootState }, payload) {
    window.googletag = window.googletag || {}
    window.googletag.cmd = window.googletag.cmd || []
    window.googletag.reloadedSlots = window.googletag.reloadedSlots || []
    window.pbjs = window.pbjs || {}
    window.pbjs.que = window.pbjs.que || []
    window.pbjs.requestManager = {
      adServerRequestSent: false,
      aps: false,
      prebid: false,
    }
    if (state.slots) {
      // clean old stuff from previous request
      window.pbjs.que.push(() => {
        window.pbjs.removeAdUnit()
      })
      window.googletag.cmd.push(() => {
        window.googletag.destroySlots()
      })
    }
    // check if we should even show any ads
    if (payload.options && payload.options.includes('all')) {
      return
    }
    if (rootState.user.access === 'BR92VTWM') {
      // remove intext banners
      const b = document.getElementsByClassName('banner-slot')
      for (const box in b) {
        if (box.id && box.id.includes('intext')) {
          box.parentElement.parentElement.classList.add('hide')
        }
      }
      return
    }
    dispatch('setupTargeting', payload)
  },
  setupTargeting({ state, commit, dispatch, rootState }, payload) {
    window.googletag = window.googletag || {}
    window.googletag.cmd = window.googletag.cmd || []
    window.googletag.reloadedSlots = window.googletag.reloadedSlots || []
    const route = payload.route || null
    if (!route.name.includes('super1')) {
      window.ybConfiguration = window.ybConfiguration || {}
      window.ybConfiguration = Object.assign({}, window.ybConfiguration, {
        integrationMethod: 'open_tag',
      })
      ;(function (y, i, e, L, D) {
        y.Yieldbird = y.Yieldbird || {}
        y.Yieldbird.cmd = y.Yieldbird.cmd || []
        i.cmd.push(function () {
          i.pubads().disableInitialLoad()
        })
        L = e.createElement('script')
        L.async = true
        L.src = '//cdn.qwtag.com/4bb2cc20-cc9a-4302-abf4-e7a722ec5e40/qw.js'
        D = e.getElementsByTagName('script')[0]
        ;(D.parentNode || e.head).insertBefore(L, D)
      })(window, window.googletag, document)
    }
    // set targeting
    const targeting = {
      wp_post_type: [],
      post_slug: [],
      post_tag: [],
      post_category: [],
    }
    if (payload.category_slug) {
      targeting.post_category = payload.category_slug.split(' ')
    }
    if (route) {
      commit('setRoute', route)
      switch (route.name) {
        case 'index':
          targeting.wp_post_type = ['home']
          break
        case 'category':
        case 'fotogalerije-category':
          targeting.wp_post_type = ['category']
          break
        case 'super1-category':
          targeting.wp_post_type = ['category']
          targeting.post_category.push('super1')
          break
        case 'pitanje-zdravlja-category':
          targeting.wp_post_type = ['category']
          targeting.post_category.push('pitanje-zdravlja')
          break
        case 'openspace-category':
          targeting.wp_post_type = ['category']
          targeting.post_category.push('openspace')
          break
        case 'super1':
          targeting.wp_post_type = ['home']
          targeting.post_category = ['super1']
          break
        case 'telesport':
          targeting.wp_post_type = ['home']
          targeting.post_category = ['telesport']
          break
        case 'tema-tema':
          targeting.wp_post_type = ['archive']
          targeting.post_category = [route.params.tema]
          if (route.params.tema === 'uefa-euro-2024') {
            targeting.post_category = [route.params.tema, 'telesport']
            targeting.wp_post_type = ['archive', 'category']
          }
          break
        case 'category-slug':
        case 'super1-category-slug':
        case 'telesport-category-slug':
        case 'openspace-category-slug':
        case 'pitanje-zdravlja-category-slug':
        case 'nesto-slug':
        case 'fotogalerije-category-slug':
          targeting.wp_post_type = ['single']
          targeting.post_slug = [route.params.slug]
          if (route.name.includes('openspace')) {
            targeting.post_category.push('openspace')
          } else if (route.name.includes('pitanje-zdravlja')) {
            targeting.post_category.push('pitanje-zdravlja')
          } else if (route.name.includes('super1')) {
            targeting.post_category.push('super1')
          } else if (route.name.includes('telesport')) {
            targeting.post_category.push('telesport')
          } else {
            targeting.post_category.push(route.params.category)
          }
          if (payload.tags) {
            targeting.post_tag = payload.tags.map((tag) => tag.slug)
          }
          break
        case 'search':
          targeting.wp_post_type = ['search']
          break
      }
    }
    window.googletag.cmd.push(() => {
      // set targeting
      for (const i in targeting) {
        if (targeting[i].length) {
          window.googletag.pubads().setTargeting(i, targeting[i])
        }
      }
      if (!rootState.user.token) {
        window.googletag.pubads().setTargeting('nosubscription', '1')
      }
      if (payload.options && payload.options.includes('nepromo')) {
        window.googletag.pubads().setCategoryExclusion('NePromo')
      }
      // window.googletag.pubads().setTargeting('env', 'test')
      if (window.prebid === 'prebid') {
        window.googletag.pubads().setTargeting('prebid', 'inhouse')
      }
      if (window.prebid === 'rubicon') {
        window.googletag.pubads().setTargeting('prebid', 'demand manager')
      }
      if (route.query.reload) {
        window.googletag.pubads().setTargeting('reload', '1')
      }
      let cookie = this.$cookies.get('ab_test')
      if (!cookie) {
        const value = Math.floor(Math.random() * 100) + 1
        if (value <= 50) {
          cookie = 'a'
        } else {
          cookie = 'b'
        }
        this.$cookies.set('ab_test', cookie, {
          path: '/',
          maxAge: 60 * 60 * 24 * 90,
        })
      }
      window.googletag.pubads().setTargeting('ab_test', cookie)
      window.googletag.pubads().enableSingleRequest()
      window.googletag.pubads().collapseEmptyDivs()
      window.googletag.pubads().disableInitialLoad()
      window.googletag.enableServices()
    })
    commit('setInit')

    dispatch('initSlots', route)
  },
  initSlots({ state, commit, dispatch, rootState }, route) {
    window.googletag.cmd.push(() => {
      const prefix = state.prefix
      const sizes = this.$mobile ? 'mobile' : 'desktop'
      let ds, unit
      for (const i of Object.keys(state.units)) {
        if (i in state.units) {
          unit = state.units[i]
          if (!unit[sizes]) {
            continue
          }
          if (route && !unit.routes.includes(route.name)) {
            continue
          }
          if (!document.getElementById(i)) {
            continue
          }
          ds = window.googletag.defineSlot(prefix + i, unit[sizes], i)
          if (ds) {
            ds.addService(window.googletag.pubads())
            /* if (i.includes('sticky') && rootState.user.access) {
              ds.setTargeting('upc', 26)
            } */
            if (unit.upc) {
              ds.setTargeting('upc', unit.upc)
            }
          }
        }
      }
      if (this.$mobile) {
        const interstitialSlot = window.googletag.defineOutOfPageSlot(
          prefix + 'telegram_interstitial',
          window.googletag.enums.OutOfPageFormat.INTERSTITIAL
        )
        if (interstitialSlot) {
          interstitialSlot.addService(window.googletag.pubads())
          commit('setInterstitialSlot', interstitialSlot)
        }
      }
      commit('setSlots')
    })
    dispatch('displaySlots')
  },
  displaySlots({ dispatch, state }) {
    window.googletag = window.googletag || {}
    window.googletag.cmd = window.googletag.cmd || []

    const slots = document.getElementsByClassName('banner-slot')
    slots.forEach((slot) => {
      window.googletag.cmd.push(function () {
        window.googletag.display(slot.id)
      })
    })
    if (state.interstitialSlot) {
      window.googletag.cmd.push(function () {
        window.googletag.display(state.interstitialSlot)
      })
    }
    dispatch('refreshSlots')
  },
  refreshSlots({ dispatch }) {
    window.googlefc = window.googlefc || {}
    window.googlefc.callbackQueue = window.googlefc.callbackQueue || []
    window.googletag = window.googletag || {}
    window.googletag.cmd = window.googletag.cmd || []
    /* global __tcfapi */
    window.googlefc.callbackQueue.push({
      CONSENT_API_READY: () =>
        __tcfapi('addEventListener', 2.2, (data, success) => {
          if (data.purpose.consents[1]) {
            dispatch('initPBJS')
          }
        }),
    })
  },
  initPBJS({ dispatch, state }) {
    window.pbjs = window.pbjs || {}
    window.pbjs.que = window.pbjs.que || []
    window.pbjs.que.push(() => {
      window.pbjs.rp.requestBids({
        callback() {
          window.googletag.cmd.push(function () {
            window.pbjs.setTargetingForGPTAsync()
            window.pbjs.requestManager.prebid = true
            dispatch('biddersBack')
          })
        },
      })
    })
    const sizes = this.$mobile ? 'mobile' : 'desktop'
    let unit
    const APSslots = []
    for (const i of Object.keys(state.units)) {
      if (i in state.units) {
        unit = state.units[i]
        if (!unit[sizes]) {
          continue
        }
        if (!document.getElementById(i)) {
          continue
        }
        APSslots.push({
          slotID: i,
          slotName: state.prefix + i,
          sizes: unit[sizes],
        })
      }
    }
    window.apstag.fetchBids(
      {
        slots: APSslots,
      },
      function (bids) {
        window.googletag.cmd.push(function () {
          window.apstag.setDisplayBids()
          window.pbjs.requestManager.aps = true
          dispatch('biddersBack')
        })
      }
    )
    setTimeout(() => {
      dispatch('initAdserver')
    }, 3500)
  },
  biddersBack({ dispatch }) {
    if (window.pbjs.requestManager.aps && window.pbjs.requestManager.prebid) {
      dispatch('initAdserver')
    }
  },
  initAdserver({ state }) {
    if (window.pbjs.requestManager.adServerRequestSent) return
    window.pbjs.requestManager.adServerRequestSent = true
    if (state.route === 'nesto-slug') {
      return
    }
    const _that = this
    window.googletag.cmd.push(function () {
      window.googletag.pubads().refresh()
      window.googletag
        .pubads()
        .addEventListener('slotRenderEnded', function (event) {
          const name = event.slot.getAdUnitPath().split('/').pop()
          const el = document.getElementById(event.slot.getSlotElementId())
          if (el) {
            if (!event.isEmpty && name.includes('intext')) {
              document
                .getElementById(event.slot.getSlotElementId() + '-info')
                .classList.remove('hide')
            }
            if (name.includes('billboard_v1')) {
              if (event.isEmpty && !_that.$mobile) {
                el.parentElement.classList.add('hide')
              }
            }
            if (event.isEmpty && name.includes('intext')) {
              el.parentElement.classList.add('hide')
            }

            if (!event.isEmpty) {
              el.style.minHeight = event.size[1] + 'px'
            } else {
              el.style.minHeight = 0 + 'px'
            }
          }
          if (!event.isEmpty) {
            window.marfeel.cmd.push([
              'compass',
              function (compass) {
                compass.trackAdEvent('slotRenderEnded', event.slot)
              },
            ])
          }
          /* if (
            !window.googletag.reloadedSlots.includes(name) &&
            event.isEmpty &&
            event.slot.getAdUnitPath().includes('wallpaper')
          ) {
            const el = document.getElementById(event.slot.getSlotElementId())
            const unit = state.units[name]
            el.innerHTML = ''
            el.removeAttribute('data-google-query-id')
            el.removeAttribute('style')
            unit.opt_div = unit.opt_div + '_new'
            el.setAttribute('id', unit.opt_div)
            unit.desktop_sizes = [
              [300, 600],
              [200, 900],
              [300, 900],
            ]
            window.googletag
              .defineSlot(state.prefix + name, unit.desktop_sizes, name)
              .addService(window.googletag.pubads())
              .setTargeting('upc', unit.upc ? unit.upc : 10)
            window.googletag.display(unit.opt_div)
            window.googletag.reloadedSlots.push(name)
          } */
        })
      window.googletag
        .pubads()
        .addEventListener('slotVisibilityChanged', function (event) {
          window.marfeel.cmd.push([
            'compass',
            function (compass) {
              compass.trackAdEvent('slotVisibilityChanged', event.slot)
            },
          ])
        })
    })
  },
}
