export const state = () => ({
  init: false,
  slots: false,
  prefix: '/1092744/telegram/',
  units: {
    telegram_desktop_billboard_v1: {
      upc: {
        desktop: 12,
        mobile: 12,
      },
      mobile: [
        [300, 50],
        [300, 100],
        [300, 250],
        [320, 50],
      ],
      desktop: [
        [970, 250],
        [970, 500],
        [1000, 250],
        [1000, 500],
        [1200, 250],
        [1200, 500],
      ],
      routes: [
        'index',
        'category',
        'category-slug',
        'nesto-slug',
        'fotogalerije-category',
        'fotogalerije-category-slug',
        'category',
        'search',
        'author-slug',
        'tema-slug',
      ],
    },
    telegram_desktop_billboard_v2: {
      upc: {
        desktop: 12,
        mobile: 12,
      },
      routes: ['index'],
      mobile: [
        [1, 1],
        [300, 50],
        [300, 100],
        [300, 250],
        [320, 50],
        [320, 480],
        [300, 600],
      ],
      desktop: [
        [1, 1],
        [970, 250],
        [970, 500],
        [1000, 250],
        [1000, 500],
        [1200, 250],
        [1200, 500],
      ],
      pbjs: {
        desktop: {
          sizes: [[970, 250]],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '970x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [929050],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2218',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
        mobile: {
          sizes: [
            [300, 250],
            [336, 280],
            [300, 600],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '300x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [950915],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2217',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2215',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
      },
    },
    telegram_desktop_billboard_v3: {
      upc: {
        desktop: 12,
        mobile: 12,
      },
      routes: ['index'],
      mobile: [
        [1, 1],
        [300, 50],
        [300, 100],
        [300, 250],
        [320, 50],
        [320, 480],
        [300, 600],
      ],
      desktop: [
        [1, 1],
        [970, 250],
        [970, 500],
        [1000, 250],
        [1000, 500],
        [1200, 250],
        [1200, 500],
      ],
      pbjs: {
        desktop: {
          sizes: [[970, 250]],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '970x250',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2218',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [929050],
              },
            },
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '970x250',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
        mobile: {
          sizes: [
            [300, 250],
            [336, 280],
            [300, 600],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '300x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [929093],
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2217',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2215',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
      },
    },
    telegram_desktop_billboard_v4: {
      upc: {
        desktop: 12,
        mobile: 12,
      },
      routes: ['index'],
      mobile: [
        [1, 1],
        [300, 50],
        [300, 100],
        [300, 250],
        [320, 50],
        [320, 480],
        [300, 600],
      ],
      desktop: [
        [1, 1],
        [970, 250],
        [970, 500],
        [1000, 250],
        [1000, 500],
        [1200, 250],
        [1200, 500],
      ],
      pbjs: {
        desktop: {
          sizes: [[970, 250]],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '970x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [929563],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2218',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
        mobile: {
          sizes: [
            [300, 250],
            [336, 280],
            [300, 600],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '300x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [950916],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2215',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2217',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
      },
    },
    telegram_desktop_wallpaper_left: {
      upc: {
        desktop: 2,
        mobile: 36,
      },
      desktop: [
        [1, 1],
        [300, 900],
        [200, 900],
        [340, 1050],
      ],
      mobile: false,
      routes: [
        'index',
        'category',
        'category-slug',
        'nesto-slug',
        'fotogalerije-category',
        'fotogalerije-category-slug',
        'category',
        'search',
        'author-slug',
        'tema-slug',
      ],
    },
    telegram_dekstop_wallpaper_right: {
      upc: {
        desktop: 36,
        mobile: 36,
      },
      desktop: [
        [1, 1],
        [301, 901],
        [201, 901],
        [341, 1051],
      ],
      mobile: false,
      routes: [
        'index',
        'category',
        'category-slug',
        'nesto-slug',
        'nesto-slug',
        'fotogalerije-category',
        'fotogalerije-category-slug',
        'category',
        'search',
        'author-slug',
        'tema-slug',
      ],
    },
    telegram_desktop_intext_v1: {
      upc: {
        desktop: 14,
        mobile: 14,
      },
      routes: ['category-slug', 'nesto-slug'],
      desktop: [
        [1, 1],
        [660, 350],
        [300, 250],
        [300, 600],
        [710, 350],
        [970, 250],
        [970, 500],
        [1200, 250],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
      ],
    },
    telegram_desktop_intext_v2: {
      upc: {
        desktop: 10,
        mobile: 10,
      },
      routes: ['category-slug', 'nesto-slug'],
      desktop: [
        [1, 1],
        [660, 350],
        [300, 250],
        [300, 600],
        [320, 480],
        [710, 350],
        [970, 500],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
      ],
      pbjs: {
        desktop: {
          sizes: [[970, 250]],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '970x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [969220],
              },
            },
            {
              bidder: 'iprom',
              params: {
                id: '1ac5399de31649f8',
                dimension: '970x250',
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2218',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
        mobile: {
          sizes: [
            [300, 250],
            [336, 280],
            [300, 600],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '300x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [929094],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2217',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2215',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
      },
    },
    telegram_desktop_intext_v3: {
      upc: {
        desktop: 10,
        mobile: 10,
      },
      routes: ['category-slug', 'nesto-slug'],
      desktop: [
        [1, 1],
        [660, 350],
        [300, 250],
        [300, 600],
        [320, 480],
        [710, 350],
        [970, 500],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
      ],
      pbjs: {
        desktop: {
          sizes: [
            [300, 250],
            [970, 250],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '970x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [950917],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2218',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
        mobile: {
          sizes: [
            [300, 250],
            [336, 280],
            [300, 600],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '300x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [950917],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2215',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2217',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
      },
    },
    telegram_desktop_intext_v4: {
      upc: {
        desktop: 13,
        mobile: 13,
      },
      routes: ['category-slug', 'nesto-slug'],
      desktop: [
        [1, 1],
        [660, 350],
        [300, 250],
        [300, 600],
        [320, 480],
        [710, 350],
        [970, 500],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
      ],
      pbjs: {
        desktop: {
          sizes: [
            [300, 250],
            [970, 250],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '970x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [950918],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2218',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
        mobile: {
          sizes: [
            [300, 250],
            [336, 280],
            [300, 600],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '300x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [950918],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2217',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'contentexchange',
              params: {
                placementId: '2215',
                adFormat: 'banner',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
      },
    },
    telegram_desktop_intext_v5: {
      upc: {
        desktop: 13,
        mobile: 13,
      },
      routes: ['category-slug', 'nesto-slug'],
      desktop: [
        [1, 1],
        [660, 350],
        [300, 250],
        [300, 600],
        [320, 480],
        [710, 350],
        [970, 500],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
      ],
      pbjs: {
        desktop: {
          sizes: [
            [300, 250],
            [970, 250],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '970x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [950919],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
        mobile: {
          sizes: [
            [300, 250],
            [336, 280],
            [300, 600],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '300x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [950919],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
      },
    },
    telegram_desktop_intext_v6: {
      upc: {
        desktop: 13,
        mobile: 13,
      },
      routes: ['category-slug', 'nesto-slug'],
      desktop: [
        [1, 1],
        [660, 350],
        [300, 250],
        [300, 600],
        [320, 480],
        [710, 350],
        [970, 500],
      ],
      mobile: [
        [1, 1],
        [300, 250],
        [320, 480],
        [336, 280],
        [320, 50],
        [300, 100],
        [300, 50],
        [300, 600],
      ],
      pbjs: {
        desktop: {
          sizes: [
            [300, 250],
            [970, 250],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '970x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [950920],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
        mobile: {
          sizes: [
            [300, 250],
            [336, 280],
            [300, 600],
          ],
          bids: [
            {
              bidder: 'iprom',
              params: {
                id: 't30769k9tyez1my7',
                dimension: '300x250',
              },
            },
            {
              bidder: 'sovrn',
              params: {
                tagid: [950920],
              },
            },
            {
              bidder: 'luponmedia',
              params: {
                siteId: 4396,
                keyId: 'uid_telegramhr',
              },
            },
            {
              bidder: 'connectad',
              params: {
                networkId: 10047,
                siteId: 1056554,
              },
            },
          ],
        },
      },
    },
    telegram_sticky: {
      upc: {
        desktop: 36,
        mobile: 36,
      },
      routes: [
        'index',
        'category',
        'category-slug',
        'nesto-slug',
        'fotogalerije-category',
        'fotogalerije-category-slug',
        'category',
        'search',
        'author-slug',
        'tema-slug',
      ],
      mobile: [
        [1, 1],
        [300, 50],
        [300, 100],
        [320, 50],
        [320, 150],
        [200, 250],
        [320, 480],
      ],
      desktop: [
        [900, 600],
        [728, 90],
        [970, 90],
        [970, 150],
        [984, 150],
        [1200, 150],
        [1200, 200],
      ],
    },
  },
  upc_b: 4,
  upc: {},
  upc_updated: null,
  route: '',
})

export const mutations = {
  setInit(state) {
    state.init = true
  },
  setSlots(state) {
    state.slots = true
  },
  setUpc(state, data) {
    state.upc = data
    state.upc_updated = new Date().getTime()
  },
  setRoute(state, route) {
    state.route = route.name
  },
}

export const actions = {
  initAds({ state, commit, dispatch, rootState }, payload) {
    window.googletag = window.googletag || {}
    window.googletag.cmd = window.googletag.cmd || []
    window.googletag.reloadedSlots = window.googletag.reloadedSlots || []
    if (state.slots) {
      // clean old stuff from previous request
      window.pbjs = window.pbjs || {}
      window.pbjs.que = window.pbjs.que || []
      window.pbjs.initAdserverSet = false
      window.pbjs.que.push(() => {
        window.pbjs.removeAdUnit()
      })
      window.googletag.cmd.push(() => {
        window.googletag.destroySlots()
      })
    }
    // check if we should even show any ads
    if (payload.options && payload.options.includes('all')) {
      return
    }
    if (rootState.user.access === 'BR92VTWM') {
      // remove intext banners
      const b = document.getElementsByClassName('banner-slot')
      for (const box in b) {
        if (box.id.includes('intext')) {
          box.parentElement.parentElement.classList.add('hide')
        }
      }
      return
    }
    // load the up to date floor data
    if (state.upc_updated + 60 * 60 * 1000 < new Date().getTime()) {
      this.$axios
        .get('/api/upc')
        .then((res) => {
          commit('setUpc', res.data)
        })
        .then(() => {
          dispatch('setupTargeting', payload)
        })
    } else {
      dispatch('setupTargeting', payload)
    }
  },
  setupTargeting({ state, commit, dispatch, rootState }, payload) {
    window.googletag = window.googletag || {}
    window.googletag.cmd = window.googletag.cmd || []
    window.googletag.reloadedSlots = window.googletag.reloadedSlots || []
    const route = payload.route || null
    // set targeting
    const targeting = {
      wp_post_type: [],
      post_slug: [],
      post_tag: [],
      post_category: [],
    }
    if (route) {
      commit('setRoute', route)
      switch (route.name) {
        case 'index':
          targeting.wp_post_type = ['home']
          break
        case 'category':
        case 'fotogalerije-category':
          targeting.wp_post_type = ['category']
          targeting.post_category = [route.params.category]
          break
        case 'tema':
          targeting.wp_post_type = ['archive']
          targeting.post_category = [route.params.slug]
          break
        case 'category-slug':
        case 'nesto-slug':
        case 'fotogalerije-category-slug':
          targeting.wp_post_type = ['single']
          targeting.post_slug = [route.params.slug]
          targeting.post_category = [route.params.category]
          if (payload.tags) {
            targeting.post_tag = payload.tags.map((tag) => tag.slug)
          }
          break
        case 'search':
          targeting.wp_post_type = ['search']
          break
      }
    }
    window.googletag.cmd.push(() => {
      // set targeting
      for (const i in targeting) {
        if (targeting[i].length) {
          window.googletag.pubads().setTargeting(i, targeting[i])
        }
      }
      if (!rootState.user.token) {
        window.googletag.pubads().setTargeting('nosubscription', '1')
      }
      if (payload.options && payload.options.includes('nepromo')) {
        window.googletag.pubads().setCategoryExclusion('NePromo')
      }
      window.googletag.pubads().enableSingleRequest()
      window.googletag.pubads().collapseEmptyDivs()
      window.googletag.pubads().disableInitialLoad()
      window.googletag.enableServices()
    })
    commit('setInit')

    dispatch('initSlots', route)
  },
  initSlots({ state, commit, dispatch }, route) {
    window.googletag.cmd.push(() => {
      const prefix = state.prefix
      const sizes = this.$mobile ? 'mobile' : 'desktop'
      let ds, unit
      for (const i of Object.keys(state.units)) {
        if (i in state.units) {
          unit = state.units[i]
          let upc = sizes === 'desktop' ? 14 : 12
          if (state.upc[i]) {
            upc = state.upc[i][sizes]
          } else {
            upc = state.upc_b
          }
          if (!unit[sizes]) {
            continue
          }
          if (route && !unit.routes.includes(route.name)) {
            continue
          }
          if (!document.getElementById(i)) {
            continue
          }
          ds = window.googletag.defineSlot(prefix + i, unit[sizes], i)
          if (ds) {
            ds.addService(window.googletag.pubads())
            ds.setTargeting('upc', upc)
          }
        }
      }
      commit('setSlots')
    })
    window.pbjs = window.pbjs || {}
    window.pbjs.que = window.pbjs.que || []
    window.pbjs.que.push(() => {
      window.pbjs.setConfig({
        enableSendAllBids: false,
        consentManagement: {
          gdpr: {
            cmpApi: 'iab',
            defaultGdprScope: true,
          },
        },
        userSync: {
          userIds: [
            {
              name: 'pubCommonId',
              storage: {
                name: '_pubcid',
                type: 'cookie',
                expires: 365,
              },
              params: {
                pixelUrl: '/wp-json/pubcid/v1/extend/',
              },
            },
          ],
          filterSettings: {
            iframe: {
              bidders: '*',
              filter: 'include',
            },
            image: {
              bidders: '*',
              filter: 'include',
            },
          },
        },
      })
      // const prefix = state.prefix
      const sizes = this.$mobile ? 'mobile' : 'desktop'
      let unit
      for (const i of Object.keys(state.units)) {
        if (i in state.units && state.units[i].pbjs) {
          unit = state.units[i]
          if (!unit.pbjs[sizes].sizes) {
            continue
          }
          if (route && !unit.routes.includes(route.name)) {
            continue
          }
          if (!document.getElementById(i)) {
            continue
          }
          window.pbjs.addAdUnits({
            code: i,
            mediaTypes: {
              banner: {
                sizes: unit.pbjs[sizes].sizes,
              },
            },
            bids: unit.pbjs[sizes].bids,
          })
        }
      }
    })
    dispatch('displaySlots')
  },
  displaySlots({ dispatch }) {
    window.googletag = window.googletag || {}
    window.googletag.cmd = window.googletag.cmd || []

    const slots = document.getElementsByClassName('banner-slot')
    slots.forEach((slot) => {
      window.googletag.cmd.push(function () {
        window.googletag.display(slot.id)
      })
    })
    dispatch('refreshSlots')
  },
  refreshSlots({ dispatch }) {
    window.googlefc = window.googlefc || {}
    window.googlefc.callbackQueue = window.googlefc.callbackQueue || []
    window.googletag = window.googletag || {}
    window.googletag.cmd = window.googletag.cmd || []
    /* global __tcfapi */
    window.googlefc.callbackQueue.push({
      CONSENT_DATA_READY: () =>
        __tcfapi('getTCData', 0, (data, success) => {
          if (data.purpose.consents[1]) {
            dispatch('initPBJS')
          }
        }),
    })
  },
  initPBJS({ dispatch }) {
    window.pbjs = window.pbjs || {}
    window.pbjs.que = window.pbjs.que || []
    window.pbjs.que.push(() => {
      window.pbjs.requestBids({
        bidsBackHandler: () => dispatch('initAdserver'),
        timeout: 1000,
      })
    })
    setTimeout(() => {
      dispatch('initAdserver')
    }, 1500)
  },
  initAdserver({ state }) {
    if (window.pbjs.initAdserverSet) return
    window.pbjs.initAdserverSet = true
    if (state.route === 'nesto-slug') {
      return
    }
    window.googletag.cmd.push(function () {
      window.pbjs.setTargetingForGPTAsync &&
        window.pbjs.setTargetingForGPTAsync()
      window.googletag.pubads().refresh()
    })

    window.googletag.cmd.push(() => {
      window.googletag
        .pubads()
        .addEventListener('slotRenderEnded', function (event) {
          const name = event.slot.getAdUnitPath().split('/').pop()
          if (!event.isEmpty && name.includes('intext')) {
            document
              .getElementById(event.slot.getSlotElementId() + '-info')
              .classList.remove('hide')
          }
          if (event.isEmpty && name.includes('billboard_v1')) {
            document.getElementById(
              event.slot.getSlotElementId()
            ).style.minHeight = 0
            document
              .getElementById(event.slot.getSlotElementId())
              .parentElement.parentElement.classList.add('hide')
          }
          if (event.isEmpty && name.includes('intext')) {
            document
              .getElementById(event.slot.getSlotElementId())
              .parentElement.classList.add('hide')
          }
          if (!event.isEmpty) {
            window.marfeel.cmd.push([
              'compass',
              function (compass) {
                compass.trackAdEvent('slotRenderEnded', event.slot)
              },
            ])
          }
        })
      window.googletag
        .pubads()
        .addEventListener('slotVisibilityChanged', function (event) {
          window.marfeel.cmd.push([
            'compass',
            function (compass) {
              compass.trackAdEvent('slotVisibilityChanged', event.slot)
            },
          ])
        })
    })
  },
}
