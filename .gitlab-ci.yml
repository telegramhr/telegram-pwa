stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  IMAGE_TAG_LATEST: $CI_REGISTRY_IMAGE:latest

before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - 'echo "Building Docker image for branch $CI_COMMIT_REF_NAME"'
    - 'docker build -t $IMAGE_TAG -t $IMAGE_TAG_LATEST .'
    - 'docker push $IMAGE_TAG'
    - 'docker push $IMAGE_TAG_LATEST'
  only:
    - smartcode-staging
    - master
    - main
  tags:
    - shared

deploy-staging:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl
    - 'echo "Deploying to staging environment"'
    - 'echo "Docker image available at $IMAGE_TAG"'
    - 'echo "Triggering Portainer webhook to pull latest image..."'
    - 'curl -k -X POST "https://10.1.1.212:9443/api/webhooks/03388cff-7b2f-4a9b-98eb-2d1fd725542f"'
    - 'echo "Portainer webhook triggered successfully"'
  environment:
    name: staging
    url: https://staging.telegram.hr
  only:
    - smartcode-staging
  tags:
    - shared

deploy-production:
  stage: deploy
  image: alpine:latest
  script:
    - 'echo "Deploying to production environment"'
    - 'echo "Docker image available at $IMAGE_TAG"'
    - 'echo "This is a manual deployment step"'
  environment:
    name: production
    url: https://telegram.hr
  only:
    - master
    - main
  when: manual
  tags:
    - shared